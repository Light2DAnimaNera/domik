# domik

## Запуск

1. Создайте и активируйте виртуальное окружение.
2. Установите зависимости: `pip install -r requirements.txt`.
3. Создайте файл `.env` и заполните его своими ключами и токенами.
4. Запустите бота: `python bot.py`.

   Для остановки нажмите `Ctrl+C` или отправьте процессу сигнал `SIGTERM`. Бот
   завершится корректно без сообщений об ошибках.

После запуска доступны команды из файла `bot_commands.py`. При вводе `/start`
бот отправит приветствие и установит меню команд согласно роли пользователя
(администратор видит расширенный список).

Баланс хранится в колонке `credits` таблицы `users`. Стоимость запроса вычисляется по количеству токенов и коэффициенту `token_cost_coeff` из таблицы `settings`. Команды `/balance`, `/coeff` и `/set_coeff` позволяют соответственно узнать текущий баланс, посмотреть и изменить коэффициент (последняя доступна только администратору).
Новые пользователи при регистрации получают 100 кредитов на счёт.

Для ведения диалогов предусмотрены сессии:
- `/begin` — начать новую сессию;
- `/end` — завершить текущую и сохранить её краткое описание. После закрытия
  полная история переписки выводится в консоль.
Одновременно может быть только одна активная сессия. При попытке запустить `/begin` во время
действующей сессии бот ответит: «Что бы начать новую сессию, заверши предыдущую сессию».
Если из-за внутренней ошибки создать сессию не удалось, бот сообщит: «Не удалось начать сессию».

Обычные сообщения обрабатываются только при активной сессии. Если её нет, бот
попросит запустить `/begin`.

При завершении сессии бот создаёт конспект по правилам SessionSummarizer v4.
Для генерации используются роли и тексты всех сообщений из базы (`SELECT role, content ...`).
Полный текст диалога также выводится в консоль.

При старте новой сессии бот ищет конспект последней завершённой сессии
пользователя. Если он найден, короткий текст передаётся модели в скрытом блоке
`CONTEXT_PREVIOUS_SESSION_*` перед системным промптом DOMINA. Пользователь не
видит этот блок, но бот учитывает его при ответах.

Основная логика общения с GPT и все используемые промпты находятся в модуле
`gpt_client.py`.
