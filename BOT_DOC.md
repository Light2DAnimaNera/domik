# Документация по боту

## Команды бота

- `/start` — выводит приветствие.
- `/all_users` — выводит список всех пользователей. Доступно только администратору.
- `/begin` — начинает диалоговую сессию и сохраняет сообщения.
- `/end` — завершает текущую сессию и создаёт краткий конспект переписки.
- `/balance` — показывает остаток средств и сегодняшние траты.
- `/coeff` — выводит текущий тарифный коэффициент (только администратор).
- `/set_coeff` — устанавливает тарифный коэффициент (только администратор).
- Новым пользователям при регистрации автоматически начисляется 100 кредитов.
- Стоимость одного токена запроса составляет `0.0005` единиц, токена ответа — `0.0019`. Значение умножается на коэффициент `token_cost_coeff`.
- По умолчанию коэффициент равен `1`.

Меню команд формируется в зависимости от роли пользователя. Обычные
пользователи получают базовый набор команд, администратор дополнительно
видит `/all_users`, `/coeff` и `/set_coeff`.

Одновременно разрешена только одна сессия. Если пользователю уже доступна активная
сессия, команда `/begin` вернёт сообщение «Что бы начать новую сессию, заверши предыдущую сессию».
При внутренней ошибке создание сессии может завершиться ответом «Не удалось начать сессию».
Сессия автоматически завершается, если пользователь бездействует 60 секунд.
При закрытии по таймауту бот просто уведомляет о завершении.

## Файлы и функции

### `bot.py`
- Создаёт объект `TeleBot`, регистрирует команды и запускает бесконечный polling.
- Обрабатывает `SIGINT`/`SIGTERM` и по сигналу вызывает `bot.stop_bot()` для корректного завершения работы.

### `bot_commands.py`
- `DEFAULT_COMMANDS` — базовые команды для всех пользователей.
- `ADMIN_COMMANDS` — дополнительные команды администратора.
- `setup_default_commands(bot, *, chat_id=None, username=None)` —
  регистрирует команды для конкретного чата с учётом роли пользователя.

### `database.py`
- `init_db()` — инициализирует базу данных SQLite и создаёт таблицы `users`, `sessions` и `messages` при первом запуске.
- `get_connection()` — возвращает соединение с базой данных.

### `config.py`
- Хранит настройки:
  - `MODEL_NAME` — название модели OpenAI;
  - `CONTEXT_LIMIT` — максимальная длина контекста;
  - `DB_PATH` — путь к файлу базы данных.

### `gpt_client.py`
- Класс `GptClient` — обёртка над API OpenAI.
  - `SYSTEM_PROMPT` — основной промпт для общения с моделью.
  - `SUMMARY_PROMPT` — инструкции для SessionSummarizer v4.
  - `__init__()` — создаёт клиента OpenAI с параметрами из переменных окружения.
  - `ask(context, user_text, previous_summary="")` — отправляет запрос и
    возвращает пару `(ответ, usage)` с данными об использованных токенах. Если
    передан конспект предыдущей сессии, он добавляется скрытым блоком перед
    системным промптом.
  - `make_summary(full_text)` — формирует краткое резюме переписки и
    возвращает его вместе с полной историей диалога.

### `models.py`
- `add_user_if_not_exists(message)` — добавляет пользователя в базу, если его там ещё нет.
- `get_all_users()` — возвращает список всех пользователей.

### `session_manager.py`
- Класс `SessionManager` управляет диалоговыми сессиями:
  - `start(user)` — создаёт новую сессию;
  - `ensure(user)` — возвращает активную сессию или создаёт новую;
  - `close(user_id, summary)` — завершает сессию;
  - `active(user_id)` — получает текущую сессию пользователя.
  - `mark_closing(user_id)` — помечает сессию как завершающуюся;
  - `unmark_closing(user_id)` — снимает пометку о завершении.
  - `session_summary(session_id)` — возвращает конспект предыдущей сессии,
    если он был найден при запуске.
  - `update_activity(user_id)` — отмечает момент последней активности.
  - `expire_idle(bot, timeout)` — закрывает неактивные более `timeout` секунд сессии и отправляет уведомление.
  - При закрытии время окончания записывается в базу в формате `mm-dd-yy HH-MM`.

### `message_logger.py`
- Класс `MessageLogger` сохраняет сообщения и формирует контекст диалога:
  - `log(session_id, role, content)` — пишет сообщение в базу и кэш. В колонку
    `created` записывает дату и время в формате `mm-dd-yy HH-MM` (московское время);
  - `context(session_id)` — возвращает историю сообщений в пределах ограничения.

### `summarizer.py`
- Функция `make_summary(session_id)` запрашивает из БД роль и текст каждого
  сообщения (`SELECT role, content ...`) и передаёт их `GptClient` для краткого
  конспекта сессии. Возвращает пару: резюме и полную историю переписки.
При запуске новой сессии `SessionManager` ищет сохранённый конспект предыдущей
и, если он найден, передаёт его `GptClient` для скрытого блока
`CONTEXT_PREVIOUS_SESSION_*`.

### `handlers.py`
- Функция `register_handlers(bot)` регистрирует обработчики:
  - `cmd_start(message)` — обрабатывает команду `/start` и отправляет приветствие.
  - `cmd_all_users(message)` — обрабатывает команду `/all_users` (только для админа).
  - `cmd_begin(message)` — запускает новую сессию, если другой не активна.
    - `cmd_end(message)` — завершает сессию, сохраняет её краткое резюме и
      выводит полную историю переписки в консоль.
    - `text_handler(message)` — отвечает на текстовые сообщения только при активной
      сессии, иначе просит запустить `/begin`. После списания кредитов выводит в
      консоль, сколько токенов потрачено на запрос и на ответ, и показывает новый
      баланс пользователя.

### `env.py`
- Загружает переменные из `.env` и экспортирует:
  - `TELEGRAM_TOKEN`
  - `OPENAI_API_KEY`
  - `OPENAI_BASE_URL` (по умолчанию `https://api.proxyapi.ru/openai/v1`)
  - `OPENAI_MODEL` (по умолчанию `gpt-4.1`)
  - `ADMIN_USERNAME` — имя администратора.

## Переменные окружения

Файл `.env` должен содержать следующие значения:

```
TELEGRAM_TOKEN=<токен Telegram бота>
OPENAI_API_KEY=<ключ OpenAI>
OPENAI_BASE_URL=<опционально: адрес API OpenAI>
OPENAI_MODEL=<опционально: модель, например gpt-4.1>
```
